<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Big Metrics | The Big House</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Lato', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #000000;
            color: #ffffff;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .dashboard {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        /* Decorative Background */
        .bg-rectangle {
            position: fixed;
            border: 2px solid rgba(104, 226, 212, 0.15);
            pointer-events: none;
            z-index: 0;
        }
        .bg-rect-1 { width: 400px; height: 300px; top: 10%; right: 5%; transform: rotate(15deg); }
        .bg-rect-2 { width: 350px; height: 250px; bottom: 15%; left: 3%; transform: rotate(-12deg); border-color: rgba(230, 0, 126, 0.15); }
        .bg-rect-3 { width: 300px; height: 200px; top: 50%; right: 20%; transform: rotate(-8deg); border-color: rgba(243, 210, 69, 0.1); }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
            z-index: 1;
        }
        .header h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 5rem;
            color: #68E2D4;
            letter-spacing: 3px;
            line-height: 1;
            margin-bottom: 8px;
        }
        .header p {
            font-size: 1.2rem;
            color: #ffffff;
            opacity: 0.9;
            font-weight: 300;
        }

        /* Controls */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            flex-wrap: wrap;
            gap: 20px;
            position: relative;
            z-index: 1;
        }
        .year-selector { display: flex; gap: 15px; }
        .year-btn {
            padding: 15px 35px;
            background: #1a1a1a;
            border: 3px solid #333;
            color: #ffffff;
            cursor: pointer;
            font-weight: 700;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 1px;
        }
        .year-btn:hover { border-color: #68E2D4; background: #222; transform: translateY(-2px); }
        .year-btn.active { background: #68E2D4; border-color: #68E2D4; color: #000000; }

        .export-controls { display: flex; gap: 10px; }
        .export-btn {
            padding: 15px 30px;
            background: #E6007E;
            color: #ffffff;
            border: none;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 1px;
        }
        .export-btn:hover { background: #ff1a8f; transform: translateY(-2px); box-shadow: 0 5px 20px rgba(230, 0, 126, 0.4); }

        /* Row Sections */
        .row-section {
            margin-bottom: 40px;
            position: relative;
            z-index: 1;
        }
        .row-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            color: #68E2D4;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #333;
            letter-spacing: 1px;
        }

        /* Metrics Grid - always 3 columns per row */
        .metrics-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
        }

        /* Metric Cards */
        .metric-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
            border: 3px solid #333;
            padding: 30px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 5px; height: 100%;
            background: #68E2D4;
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        .metric-card:hover {
            border-color: #68E2D4;
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(104, 226, 212, 0.3);
        }
        .metric-card:hover::before { transform: scaleY(1); }

        .metric-label {
            font-size: 0.85rem;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 15px;
            font-weight: 700;
        }
        .metric-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3rem;
            font-weight: 700;
            color: #68E2D4;
            margin-bottom: 8px;
            line-height: 1;
        }
        .metric-subtitle {
            font-size: 0.9rem;
            color: #666;
            font-weight: 400;
        }

        /* Colour coding */
        .color-positive { color: #00ff99 !important; }
        .color-negative { color: #ff4444 !important; }
        .color-yes { color: #00ff99 !important; }
        .color-no { color: #ff4444 !important; }

        /* Quarter Tabs */
        .quarter-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 15px;
        }
        .quarter-tab {
            padding: 8px 16px;
            background: #1a1a1a;
            border: 2px solid #333;
            border-bottom: none;
            color: #999;
            cursor: pointer;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.95rem;
            letter-spacing: 1px;
            transition: all 0.2s ease;
        }
        .quarter-tab:hover { color: #fff; border-color: #555; }
        .quarter-tab.active {
            background: #68E2D4;
            color: #000;
            border-color: #68E2D4;
            font-weight: 700;
        }
        .quarter-content { display: none; }
        .quarter-content.active { display: block; }

        /* Chart Section */
        .section {
            background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
            border: 3px solid #333;
            padding: 40px;
            margin-bottom: 40px;
            position: relative;
            z-index: 1;
        }
        .section-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: #68E2D4;
            margin-bottom: 30px;
            border-bottom: 3px solid #333;
            padding-bottom: 15px;
            letter-spacing: 1px;
        }
        .chart-container {
            position: relative;
            height: 450px;
            margin-top: 30px;
        }

        /* Role Gap Table */
        .role-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .role-table th {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
            color: #68E2D4;
            text-align: left;
            padding: 12px 16px;
            border-bottom: 3px solid #333;
            letter-spacing: 1px;
        }
        .role-table td {
            padding: 10px 16px;
            border-bottom: 1px solid #222;
            font-size: 0.95rem;
        }
        .role-table tr:hover { background: rgba(104, 226, 212, 0.05); }
        .role-table .role-name { color: #fff; font-weight: 700; }
        .role-table .gap-value { font-family: 'Bebas Neue', sans-serif; font-size: 1.2rem; }
        .role-table .overheads-row { border-top: 3px solid #333; font-weight: 700; }

        /* Loading / Error */
        .loading {
            text-align: center;
            padding: 60px;
            font-size: 1.2rem;
            color: #68E2D4;
        }
        .error {
            background: rgba(255, 68, 68, 0.1);
            border: 2px solid #ff4444;
            padding: 20px;
            color: #ff4444;
            margin: 20px 0;
        }

        /* Year content toggle */
        .year-content { display: none; }
        .year-content.active { display: block; }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .metrics-row {
                grid-template-columns: repeat(2, 1fr);
            }
            .metrics-row .metric-card:nth-child(3) {
                grid-column: span 2;
            }
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 3rem; }
            .controls { flex-direction: column; align-items: stretch; }
            .year-selector { justify-content: center; }
            .export-controls { justify-content: center; }
            .metrics-row {
                grid-template-columns: 1fr;
            }
            .metrics-row .metric-card:nth-child(3) {
                grid-column: span 1;
            }
            .metric-value { font-size: 2.2rem; }
            .chart-container { height: 350px; }
            .year-btn { padding: 12px 20px; font-size: 1rem; }
            .export-btn { padding: 12px 20px; font-size: 0.9rem; }
            .section { padding: 20px; }
            .row-title { font-size: 1.4rem; }
            .role-table { font-size: 0.85rem; }
            .role-table th, .role-table td { padding: 8px 10px; }
            .role-table .gap-value { font-size: 1rem; }
            .bg-rectangle { display: none; }
        }

        @media (max-width: 480px) {
            .dashboard { padding: 10px; }
            .header h1 { font-size: 2.2rem; }
            .metric-card { padding: 20px; }
            .metric-value { font-size: 1.8rem; }
            .metric-label { font-size: 0.75rem; letter-spacing: 1px; }
            .quarter-tab { padding: 6px 10px; font-size: 0.8rem; }
        }
    </style>
</head>
<body>
    <div class="bg-rectangle bg-rect-1"></div>
    <div class="bg-rectangle bg-rect-2"></div>
    <div class="bg-rectangle bg-rect-3"></div>

    <div class="dashboard" id="dashboard">
        <div class="header">
            <h1>THE BIG METRICS</h1>
            <p>Funding Intelligence Dashboard | The Big House</p>
        </div>

        <div id="loadingIndicator" class="loading">Loading live data from Google Sheets...</div>
        <div id="errorContainer"></div>

        <div id="dashboardContent" style="display: none;">
            <div class="controls">
                <div class="year-selector">
                    <button class="year-btn active" data-year="2026">2026</button>
                    <button class="year-btn" data-year="2027">2027</button>
                    <button class="year-btn" data-year="2028">2028</button>
                </div>
                <div class="export-controls">
                    <button class="export-btn" onclick="exportPNG()">Export PNG</button>
                    <button class="export-btn" onclick="exportPDF()">Export PDF</button>
                </div>
            </div>

            <div id="metricsContainer"></div>
        </div>
    </div>

    <script>
        // ─── Configuration ───
        const SHEET_ID = '1bz8or3CviDNZBOfKAGsLPXwqHzkkMH6eIkmCBoBoEA0';
        const API_KEY = 'AIzaSyCp3ADGwVPjPnVA1CUkuLpgMueI0hOYgCE';

        let sheetData = {};
        let currentYear = '2026';
        let charts = {};

        const incomeLabels = ['Corporate', 'Individual', 'T&F', 'Statutory', 'Earned', 'Tax Relief', 'Events', 'Interest'];

        // ─── Fetch Data ───
        async function fetchSheetData() {
            try {
                const claudeUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Claude%20data!A1:C30?key=${API_KEY}`;
                const targetsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Fundraising%20Targets!A1:H30?key=${API_KEY}`;
                const rolesUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/3-year%20income%20overview!B64:L79?key=${API_KEY}`;

                const [claudeRes, targetsRes, rolesRes] = await Promise.all([
                    fetch(claudeUrl),
                    fetch(targetsUrl),
                    fetch(rolesUrl)
                ]);

                if (!claudeRes.ok || !targetsRes.ok) {
                    throw new Error('Failed to fetch data. Please check sheet permissions and API key.');
                }

                const claudeData = await claudeRes.json();
                const targetsData = await targetsRes.json();

                sheetData.claude = claudeData.values || [];
                sheetData.targets = targetsData.values || [];

                // Roles data may not exist yet - handle gracefully
                if (rolesRes.ok) {
                    const rolesData = await rolesRes.json();
                    sheetData.roles = rolesData.values || [];
                } else {
                    sheetData.roles = [];
                }

                parseData();
                renderDashboard();

                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('errorContainer').innerHTML = `
                    <div class="error">
                        <strong>Error loading data:</strong> ${error.message}<br><br>
                        Please ensure the Google Sheet is accessible and the API key is valid.
                    </div>
                `;
            }
        }

        // ─── Cell Parser (handles negatives, currency symbols, parentheses) ───
        function getCell(data, row, col) {
            if (data && data[row] && data[row][col] !== undefined) {
                let value = data[row][col];
                if (typeof value === 'string') {
                    value = value.trim();
                    // Check for parenthesised negatives e.g. (£50,000)
                    const isNegParens = /^\(.*\)$/.test(value);
                    // Check for leading minus
                    const isNegMinus = /^-/.test(value);
                    // Strip everything except digits, dots, minus
                    let cleaned = value.replace(/[£$,%()]/g, '').replace(/,/g, '').trim();
                    let num = parseFloat(cleaned) || 0;
                    // Apply negative if parenthesised
                    if (isNegParens && num > 0) num = -num;
                    return num;
                }
                return parseFloat(value) || 0;
            }
            return 0;
        }

        // ─── Parse All Data ───
        function parseData() {
            const c = sheetData.claude;
            const t = sheetData.targets;
            const r = sheetData.roles;

            // Parse roles data: fetched range is B64:L79
            // B65:B74 = rows index 1-10 (col 0 = B)
            // J65:J74 = col 8 (J), L65:L74 = col 10 (L)
            // J78 = row index 14 col 8, L78 = row index 14 col 10
            let roles = [];
            let overheadsGap2026 = 0;
            let overheadsGap2027 = 0;

            if (r && r.length > 0) {
                for (let i = 1; i <= 10; i++) {
                    if (r[i]) {
                        roles.push({
                            name: r[i][0] || '',
                            gap2026: getCell(r, i, 8),
                            gap2027: getCell(r, i, 10)
                        });
                    }
                }
                // Overheads gap: row index 14 (B78 area)
                overheadsGap2026 = getCell(r, 14, 8);
                overheadsGap2027 = getCell(r, 14, 10);
            }

            sheetData.parsed = {
                roles: roles,
                overheadsGap2026: overheadsGap2026,
                overheadsGap2027: overheadsGap2027,
                2026: {
                    // Row 1: Financial Overview
                    target: getCell(c, 1, 0),          // A2
                    expenditure: getCell(c, 26, 0),     // A27 (new)
                    surplus: getCell(c, 22, 0),         // A23

                    // Row 2: Secured Income
                    secured: getCell(c, 7, 0),          // A8
                    percentageReached: getCell(c, 19, 0), // A20
                    gap: getCell(c, 16, 0),             // A17

                    // Row 3: Pipeline
                    weightedPipeline: getCell(c, 13, 0), // A14
                    totalPipeline: getCell(c, 10, 0),    // A11

                    // Income streams - Fundraising Targets tab
                    // Targets: F9-F16 = col 5, rows 8-15
                    incomeTargets: [
                        getCell(t, 8, 5), getCell(t, 9, 5), getCell(t, 10, 5), getCell(t, 11, 5),
                        getCell(t, 12, 5), getCell(t, 13, 5), getCell(t, 14, 5), getCell(t, 15, 5)
                    ],
                    // Actuals: F21-F28 = col 5, rows 20-27
                    incomeActuals: [
                        getCell(t, 20, 5), getCell(t, 21, 5), getCell(t, 22, 5), getCell(t, 23, 5),
                        getCell(t, 24, 5), getCell(t, 25, 5), getCell(t, 26, 5), getCell(t, 27, 5)
                    ]
                },
                2027: {
                    target: getCell(c, 1, 1),           // B2
                    expenditure: getCell(c, 26, 1),      // B27
                    surplus: getCell(c, 22, 1),          // B23

                    secured: getCell(c, 7, 1),           // B8
                    percentageReached: getCell(c, 19, 1), // B20
                    gap: getCell(c, 16, 1),              // B17

                    weightedPipeline: getCell(c, 13, 1), // B14

                    // Targets: H9-H16 = col 7, rows 8-15
                    incomeTargets: [
                        getCell(t, 8, 7), getCell(t, 9, 7), getCell(t, 10, 7), getCell(t, 11, 7),
                        getCell(t, 12, 7), getCell(t, 13, 7), getCell(t, 14, 7), getCell(t, 15, 7)
                    ],
                    // Actuals: H21-H28 = col 7, rows 20-27
                    incomeActuals: [
                        getCell(t, 20, 7), getCell(t, 21, 7), getCell(t, 22, 7), getCell(t, 23, 7),
                        getCell(t, 24, 7), getCell(t, 25, 7), getCell(t, 26, 7), getCell(t, 27, 7)
                    ]
                },
                2028: {
                    target: getCell(c, 1, 2),           // C2
                    expenditure: getCell(c, 26, 2),      // C27
                    surplus: getCell(c, 22, 2),          // C23

                    secured: getCell(c, 7, 2),           // C8
                    percentageReached: 0,
                    gap: 0,

                    weightedPipeline: 0
                }
            };
        }

        // ─── Formatting Helpers ───
        function formatCurrency(value) {
            const abs = Math.abs(value);
            const formatted = new Intl.NumberFormat('en-GB', {
                style: 'currency', currency: 'GBP',
                minimumFractionDigits: 0, maximumFractionDigits: 0
            }).format(abs);
            return value < 0 ? '-' + formatted : formatted;
        }

        function formatPercent(value) {
            return Math.round(value) + '%';
        }

        function colorClass(value) {
            if (value > 0) return 'color-positive';
            if (value < 0) return 'color-negative';
            return '';
        }

        // ─── Render Dashboard ───
        function renderDashboard() {
            const container = document.getElementById('metricsContainer');
            let html = '';

            ['2026', '2027', '2028'].forEach(year => {
                const d = sheetData.parsed[year];
                const isActive = year === currentYear ? 'active' : '';
                const is2028 = year === '2028';

                // Does pipeline cover gap? weighted pipeline + gap > 0 means yes
                const pipelineCoversGap = (d.weightedPipeline + d.gap) > 0;

                html += `<div class="year-content ${isActive}" id="year-${year}">`;

                // ──── ROW 1: Financial Overview ────
                html += `
                    <div class="row-section">
                        <div class="row-title">Financial Overview</div>
                        <div class="metrics-row">
                            <div class="metric-card">
                                <div class="metric-label">Income Target</div>
                                <div class="metric-value">${formatCurrency(d.target)}</div>
                                <div class="metric-subtitle">Annual target</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Forecast Expenditure</div>
                                <div class="metric-value">${formatCurrency(d.expenditure)}</div>
                                <div class="metric-subtitle">Projected spend</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Planned Surplus / Deficit</div>
                                <div class="metric-value ${colorClass(d.surplus)}">${formatCurrency(d.surplus)}</div>
                                <div class="metric-subtitle">${d.surplus >= 0 ? 'Surplus' : 'Deficit'}</div>
                            </div>
                        </div>
                    </div>`;

                // ──── ROW 2: Secured Income Against Target ────
                html += `
                    <div class="row-section">
                        <div class="row-title">Secured Income Against Target</div>
                        <div class="metrics-row">
                            <div class="metric-card">
                                <div class="metric-label">Secured Income</div>
                                <div class="metric-value">${formatCurrency(d.secured)}</div>
                                <div class="metric-subtitle">Awarded funding</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Target Reached</div>
                                <div class="metric-value">${!is2028 ? formatPercent(d.percentageReached) : 'N/A'}</div>
                                <div class="metric-subtitle">Of income target</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Funding Gap</div>
                                <div class="metric-value ${colorClass(d.gap)}">${!is2028 ? formatCurrency(d.gap) : 'N/A'}</div>
                                <div class="metric-subtitle">${d.gap >= 0 ? 'Target exceeded' : 'Still to raise'}</div>
                            </div>
                        </div>
                    </div>`;

                // ──── ROW 3: Pipeline Analysis ────
                html += `
                    <div class="row-section">
                        <div class="row-title">Pipeline Analysis</div>
                        <div class="metrics-row">
                            <div class="metric-card">
                                <div class="metric-label">Weighted Pipeline</div>
                                <div class="metric-value">${!is2028 ? formatCurrency(d.weightedPipeline) : 'N/A'}</div>
                                <div class="metric-subtitle">Risk-adjusted value</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Does Pipeline Cover Gap?</div>
                                <div class="metric-value ${!is2028 ? (pipelineCoversGap ? 'color-yes' : 'color-no') : ''}">${!is2028 ? (pipelineCoversGap ? 'YES' : 'NO') : 'N/A'}</div>
                                <div class="metric-subtitle">${!is2028 ? (pipelineCoversGap ? 'Pipeline exceeds shortfall' : 'Additional fundraising needed') : ''}</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Output by Quarter</div>
                                <div class="quarter-tabs">
                                    <div class="quarter-tab active" onclick="switchQuarter(this, '${year}', 'q1')">Q1</div>
                                    <div class="quarter-tab" onclick="switchQuarter(this, '${year}', 'q2')">Q2</div>
                                    <div class="quarter-tab" onclick="switchQuarter(this, '${year}', 'q3')">Q3</div>
                                    <div class="quarter-tab" onclick="switchQuarter(this, '${year}', 'q4')">Q4</div>
                                </div>
                                <div id="quarter-${year}-q1" class="quarter-content active">
                                    <div class="metric-value" style="font-size: 2rem;">—</div>
                                    <div class="metric-subtitle">Data coming soon</div>
                                </div>
                                <div id="quarter-${year}-q2" class="quarter-content">
                                    <div class="metric-value" style="font-size: 2rem;">—</div>
                                    <div class="metric-subtitle">Data coming soon</div>
                                </div>
                                <div id="quarter-${year}-q3" class="quarter-content">
                                    <div class="metric-value" style="font-size: 2rem;">—</div>
                                    <div class="metric-subtitle">Data coming soon</div>
                                </div>
                                <div id="quarter-${year}-q4" class="quarter-content">
                                    <div class="metric-value" style="font-size: 2rem;">—</div>
                                    <div class="metric-subtitle">Data coming soon</div>
                                </div>
                            </div>
                        </div>
                    </div>`;

                // ──── BAR CHART: Income Targets vs Actuals ────
                if (d.incomeTargets && d.incomeActuals) {
                    html += `
                        <div class="section">
                            <div class="section-title">Income Breakdown: Target vs Actual (${year})</div>
                            <div class="chart-container">
                                <canvas id="incomeChart${year}"></canvas>
                            </div>
                        </div>`;
                }

                // ──── ROLE GAP TABLE (show for 2026 & 2027) ────
                if (!is2028 && sheetData.parsed.roles.length > 0) {
                    const gapKey = year === '2026' ? 'gap2026' : 'gap2027';
                    const overheadsGap = year === '2026' ? sheetData.parsed.overheadsGap2026 : sheetData.parsed.overheadsGap2027;

                    html += `
                        <div class="section">
                            <div class="section-title">Income Gap by Role (${year})</div>
                            <table class="role-table">
                                <thead>
                                    <tr>
                                        <th>Role</th>
                                        <th>Gap (${year})</th>
                                    </tr>
                                </thead>
                                <tbody>`;

                    sheetData.parsed.roles.forEach(role => {
                        if (role.name) {
                            const gapVal = role[gapKey];
                            html += `
                                    <tr>
                                        <td class="role-name">${role.name}</td>
                                        <td class="gap-value ${colorClass(gapVal)}">${formatCurrency(gapVal)}</td>
                                    </tr>`;
                        }
                    });

                    // Overheads row
                    html += `
                                    <tr class="overheads-row">
                                        <td class="role-name">Overheads</td>
                                        <td class="gap-value ${colorClass(overheadsGap)}">${formatCurrency(overheadsGap)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>`;
                }

                html += `</div>`; // close year-content
            });

            container.innerHTML = html;

            // Set up year button listeners
            document.querySelectorAll('.year-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    switchYear(this.dataset.year);
                });
            });

            // Create charts for the active year
            createIncomeChart(currentYear);
        }

        // ─── Income Bar Chart ───
        function createIncomeChart(year) {
            const canvasId = `incomeChart${year}`;
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            if (charts[canvasId]) charts[canvasId].destroy();

            const d = sheetData.parsed[year];
            if (!d || !d.incomeTargets || !d.incomeActuals) return;

            charts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: incomeLabels,
                    datasets: [
                        {
                            label: 'Target',
                            data: d.incomeTargets,
                            backgroundColor: '#68E2D4',
                            borderColor: '#68E2D4',
                            borderWidth: 0
                        },
                        {
                            label: 'Actual',
                            data: d.incomeActuals,
                            backgroundColor: '#E6007E',
                            borderColor: '#E6007E',
                            borderWidth: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#ffffff',
                                font: { size: 16, weight: 'bold', family: 'Bebas Neue' },
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'rect'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            titleColor: '#68E2D4',
                            bodyColor: '#ffffff',
                            borderColor: '#68E2D4',
                            borderWidth: 2,
                            padding: 12,
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#ffffff',
                                font: { size: 12, weight: 'bold' },
                                callback: value => '£' + (value / 1000).toFixed(0) + 'k'
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: {
                                color: '#ffffff',
                                font: { size: 11, weight: 'bold' }
                            },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // ─── Year Switching ───
        function switchYear(year) {
            currentYear = year;
            document.querySelectorAll('.year-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`year-${year}`).classList.add('active');
            document.querySelectorAll('.year-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.year === year);
            });
            setTimeout(() => createIncomeChart(year), 100);
        }

        // ─── Quarter Tab Switching ───
        function switchQuarter(tabEl, year, quarter) {
            // Toggle tab active state
            tabEl.parentElement.querySelectorAll('.quarter-tab').forEach(t => t.classList.remove('active'));
            tabEl.classList.add('active');
            // Toggle content
            const card = tabEl.closest('.metric-card');
            card.querySelectorAll('.quarter-content').forEach(c => c.classList.remove('active'));
            card.querySelector(`#quarter-${year}-${quarter}`).classList.add('active');
        }

        // ─── Export PNG ───
        function exportPNG() {
            const dashboard = document.getElementById('dashboard');
            html2canvas(dashboard, { backgroundColor: '#000000', scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `big-metrics-${currentYear}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }

        // ─── Export PDF ───
        function exportPDF() {
            const dashboard = document.getElementById('dashboard');
            html2canvas(dashboard, { backgroundColor: '#000000', scale: 2 }).then(canvas => {
                const { jsPDF } = window.jspdf;
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const pdfWidth = 297; // A4 landscape width mm
                const pdfHeight = (imgHeight * pdfWidth) / imgWidth;
                const pdf = new jsPDF('l', 'mm', [pdfWidth, pdfHeight]);
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`big-metrics-${currentYear}.pdf`);
            });
        }

        // ─── Initialize ───
        fetchSheetData();
    </script>
</body>
</html>

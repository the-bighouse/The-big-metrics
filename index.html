<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TBH Funding Intelligence | The Big House</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Lato:wght@400;700;900&display=swap" rel="stylesheet">
<style>
:root{--pk:#E6007E;--tl:#68E2D4;--yl:#F3D245;--bl:#42AEF0;--gn:#34d399;--rd:#ef4444;--cd:#111;--bd:#1a1a1a;--sc:#888;--mt:#555}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Lato',-apple-system,sans-serif;background:#000;color:#fff;line-height:1.5;overflow-x:hidden}
.bb{font-family:'Bebas Neue',sans-serif;letter-spacing:1px}
.bg-r{position:fixed;border:1.5px solid;pointer-events:none;z-index:0;opacity:.06}
.r1{width:500px;height:350px;top:5%;right:-5%;transform:rotate(12deg);border-color:var(--tl)}
.r2{width:450px;height:300px;top:6%;right:-4%;transform:rotate(12deg);border-color:var(--pk)}
.r3{width:400px;height:280px;bottom:10%;left:-3%;transform:rotate(-8deg);border-color:var(--tl)}
.dash{max-width:1600px;margin:0 auto;padding:16px 20px;position:relative;z-index:1}
.hdr{display:flex;justify-content:space-between;align-items:center;padding:16px 0;border-bottom:1px solid var(--bd);margin-bottom:20px;flex-wrap:wrap;gap:10px}
.hdr-t{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:2px}
.hdr-t span{color:var(--pk)}
.hdr-s{font-size:11px;color:var(--mt);margin-top:2px}
.hdr-r{display:flex;align-items:center;gap:14px}
.scan{font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:2px;padding:8px 22px;background:var(--pk);color:#fff;border:none;cursor:pointer;border-radius:2px;transition:all .2s}
.scan:hover{background:#ff1a8f;transform:translateY(-1px)}
.nav{display:flex;gap:4px;margin-bottom:16px;flex-wrap:wrap}
.nav-b{font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:1.5px;padding:8px 18px;border:none;cursor:pointer;background:transparent;color:var(--mt);border-radius:2px;transition:all .15s}
.nav-b.on{background:var(--pk);color:#fff}
.nav-b:not(.on):hover{color:#fff;background:#1a1a1a}
.badge{display:inline-flex;align-items:center;justify-content:center;min-width:16px;height:16px;padding:0 5px;border-radius:8px;background:var(--pk);color:#fff;font-size:9px;font-weight:700;margin-left:6px;font-family:Lato}
.yr-tabs{display:flex;gap:4px;margin-bottom:14px}
.yr-b{font-family:'Bebas Neue',sans-serif;font-size:12px;letter-spacing:1px;padding:5px 16px;border:1px solid var(--bd);background:transparent;color:var(--mt);cursor:pointer;border-radius:2px;transition:all .15s}
.yr-b.on{background:var(--tl);color:#000;border-color:var(--tl)}
.sec-t{font-family:'Bebas Neue',sans-serif;font-size:15px;color:var(--pk);letter-spacing:2px;margin-bottom:8px;padding-left:2px}
.mrow{display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap}
.mc{background:var(--cd);border:1px solid var(--bd);border-radius:4px;padding:14px 16px;flex:1;min-width:160px}
.mc-l{font-size:10px;color:var(--sc);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
.mc-v{font-family:'Bebas Neue',sans-serif;font-size:26px;line-height:1.1}
.gap-c{margin-bottom:14px}
.gap-h{display:flex;justify-content:space-between;margin-bottom:4px}
.gap-trk{height:22px;background:#1a1a1a;border-radius:3px;overflow:hidden;position:relative}
.gap-s{position:absolute;height:100%;background:var(--tl);border-radius:3px;opacity:.85;transition:width .5s}
.gap-w{position:absolute;height:100%;background:var(--pk);border-radius:3px;opacity:.4;transition:width .5s}
.gap-f{display:flex;justify-content:space-between;margin-top:2px;font-size:9px;color:var(--mt)}
.tw{background:var(--cd);border:1px solid var(--bd);border-radius:4px;overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;font-size:12px;min-width:800px}
thead tr{background:#141414}
th{padding:10px;text-align:left;color:var(--mt);font-family:'Bebas Neue',sans-serif;font-size:11px;letter-spacing:1px;border-bottom:1px solid var(--bd);white-space:nowrap}
td{padding:7px 10px;border-bottom:1px solid #0d0d0d;white-space:nowrap}
tr:hover td{background:#0d0d0d}
.tf{padding:8px 10px;border-top:1px solid var(--bd);background:#141414;display:flex;justify-content:space-between;font-size:11px}
.sb{display:inline-flex;align-items:center;gap:4px;padding:2px 10px;border-radius:12px;font-size:10px;font-weight:700;cursor:pointer;user-select:none;transition:all .15s}
.sb:hover{filter:brightness(1.2);transform:scale(1.05)}
.sb .dt{width:5px;height:5px;border-radius:50%}
.sb-sec{background:#0a2e1f;color:#6ee7b7}.sb-sec .dt{background:#34d399}
.sb-app{background:#0f2744;color:#93c5fd}.sb-app .dt{background:#60a5fa}
.sb-pro{background:#2a1f0a;color:#fbbf24}.sb-pro .dt{background:#f59e0b}
.sb-eoi{background:#1a1a2e;color:#a78bfa}.sb-eoi .dt{background:#8b5cf6}
.sb-uns{background:#2a0a0a;color:#fca5a5}.sb-uns .dt{background:#ef4444}
.flt{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap;align-items:center}
.fb{font-size:10px;padding:4px 10px;border:1px solid var(--bd);background:transparent;color:var(--mt);cursor:pointer;border-radius:3px;transition:all .15s}
.fb.on{border-color:var(--tl);color:var(--tl);background:rgba(104,226,212,.08)}
.fsep{width:1px;height:16px;background:var(--bd);margin:0 2px}
.dg{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:10px}
.dc{background:var(--cd);border:1px solid var(--bd);border-radius:4px;padding:14px;border-left:3px solid var(--tl)}
.dc.hi{border-left-color:var(--gn)}.dc.md{border-left-color:var(--yl)}.dc.lo{border-left-color:var(--rd)}
.abtn{font-size:10px;padding:4px 12px;background:var(--pk);color:#fff;border:none;border-radius:3px;cursor:pointer;font-weight:700;font-family:'Bebas Neue',sans-serif;letter-spacing:1px}
.abtn:hover{background:#ff1a8f}
.dbtn{font-size:10px;padding:4px 12px;background:transparent;color:var(--mt);border:1px solid var(--bd);border-radius:3px;cursor:pointer}
.rc{background:var(--cd);border:1px solid var(--bd);border-radius:4px;padding:14px;margin-bottom:10px}
.rft{display:inline-block;padding:2px 8px;background:rgba(104,226,212,.1);color:var(--tl);border-radius:3px;font-size:10px;margin:2px 4px 2px 0;cursor:pointer;transition:background .15s}
.rft:hover{background:rgba(104,226,212,.2)}
.rft.done{opacity:.6;cursor:default;background:rgba(52,211,153,.1);color:var(--gn)}
.oc{background:var(--cd);border:1px solid var(--bd);border-radius:4px;padding:12px;margin-bottom:8px}
.ot{font-size:9px;padding:2px 6px;background:#1a1a1a;color:var(--sc);border-radius:2px;display:inline-block;margin:1px}
.sc-c{background:var(--cd);border:1px solid var(--bd);border-radius:4px;padding:16px;margin-bottom:10px}
.sc-st{font-size:10px;padding:2px 8px;border-radius:10px;font-weight:700;white-space:nowrap}
.sc-live{background:#0a2e1f;color:#6ee7b7}.sc-plan{background:#2a1f0a;color:#fbbf24}.sc-idea{background:#1a1a1a;color:#888}
.cc{background:var(--cd);border:1px solid var(--bd);border-radius:4px;padding:16px;margin-bottom:16px}
.mo{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:100;display:flex;align-items:center;justify-content:center}
.mb{background:var(--cd);border:1px solid var(--bd);border-radius:6px;padding:24px;width:90%;max-width:480px;max-height:90vh;overflow-y:auto}
.mb h3{font-family:'Bebas Neue',sans-serif;font-size:20px;margin-bottom:14px;letter-spacing:1px}
.mb label{font-size:10px;color:var(--sc);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:4px}
.mb input,.mb select{width:100%;padding:10px 12px;background:#1a1a1a;border:1px solid #333;color:#fff;border-radius:3px;font-size:13px;margin-bottom:10px;font-family:Lato,sans-serif}
.mb input::placeholder{color:var(--mt)}
.ma{display:flex;gap:8px;justify-content:flex-end;margin-top:14px}
.mcnl{padding:8px 16px;background:transparent;color:var(--mt);border:1px solid #333;border-radius:3px;cursor:pointer;font-size:12px}
.msub{padding:8px 16px;background:var(--pk);color:#fff;border:none;border-radius:3px;cursor:pointer;font-size:12px;font-weight:700}
.toast{position:fixed;bottom:20px;right:20px;background:var(--gn);color:#000;padding:10px 20px;border-radius:4px;font-size:12px;font-weight:700;z-index:200;animation:fi .3s}
.toast.err{background:var(--rd);color:#fff}
@keyframes fi{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.ld{text-align:center;padding:60px 20px;color:var(--mt)}
.sp{width:30px;height:30px;border:3px solid #333;border-top-color:var(--pk);border-radius:50%;animation:spn .8s linear infinite;margin:0 auto 12px}
@keyframes spn{to{transform:rotate(360deg)}}
.prog{height:4px;background:#1a1a1a;border-radius:2px;overflow:hidden;margin:8px 0}
.prog-bar{height:100%;background:var(--tl);border-radius:2px;transition:width .3s}
.src-tag{display:inline-block;font-size:8px;padding:1px 5px;border-radius:2px;background:#1a1a1a;color:var(--mt);margin-left:4px;vertical-align:middle}
@media(max-width:768px){.mrow{flex-direction:column}.mc{min-width:auto}.hdr{flex-direction:column;align-items:flex-start}.dg{grid-template-columns:1fr}.nav-b{font-size:11px;padding:6px 12px}}
</style>
</head>
<body>
<div class="bg-r r1"></div><div class="bg-r r2"></div><div class="bg-r r3"></div>
<div class="dash" id="app"><div class="ld"><div class="sp"></div><div class="bb" style="font-size:16px;letter-spacing:2px">LOADING FUNDING INTELLIGENCE...</div></div></div>
<div id="tc"></div>
<script>
// ═══════════════════════════════════════════════════════════════
// CONFIG
// ═══════════════════════════════════════════════════════════════
const SID='1bz8or3CviDNZBOfKAGsLPXwqHzkkMH6eIkmCBoBoEA0',AK='AIzaSyCp3ADGwVPjPnVA1CUkuLpgMueI0hOYgCE';
const TBH_CC='1151106';
const API360='https://api.threesixtygiving.org/api/v1';
const STATS=['Prospect','EOI','Applied for','Secured','Unsuccessful'];
const SBC={Secured:'sb-sec','Applied for':'sb-app',Prospect:'sb-pro',EOI:'sb-eoi',Unsuccessful:'sb-uns'};

let S={tab:'overview',yr:'2026',sF:'all',yF:'all',tF:'all',modal:null,sd:null,nid:100,
  scanProg:0,scanTotal:0,scanning:false,discLoaded:false};

// ═══════════════════════════════════════════════════════════════
// PIPELINE — will be loaded from Google Sheet "Pipeline" tab
// ═══════════════════════════════════════════════════════════════
let PIPE=[];

// ═══════════════════════════════════════════════════════════════
// DISCOVERY — populated by 360Giving scan, NOT hardcoded
// ═══════════════════════════════════════════════════════════════
let DISC=[];      // {n,s,t,r,orgs:[],grants:N,lastGrant,avgGrant,maxGrant,desc}
let OVER=[];      // {n,c,o:[orgnames],s,totalGrants,totalValue}
let FUNDER_DB={}; // funderName -> {orgs:Set,grants:[],totalValue,avgGrant,lastYear}

// ═══════════════════════════════════════════════════════════════
// COMPARABLES — with charity numbers for 360Giving lookups
// ═══════════════════════════════════════════════════════════════
const COMPS=[
{n:"Cardboard Citizens",cat:"Arts + Youth",fc:0,l:"—",cc:"1074009"},
{n:"Clean Break",cat:"Arts + Youth",fc:0,l:"—",cc:"1017560"},
{n:"Synergy Theatre Project",cat:"Arts + Youth",fc:0,l:"—",cc:"1069451"},
{n:"Company Three",cat:"Arts + Youth",fc:0,l:"—",cc:"1069797"},
{n:"Chickenshed",cat:"Arts + Youth",fc:0,l:"—",cc:"1012369"},
{n:"Only Connect",cat:"Arts + Youth",fc:0,l:"—",cc:"1087648"},
{n:"Settle",cat:"Care / Advocacy",fc:0,l:"—",cc:"1152548"},
{n:"Become",cat:"Care / Advocacy",fc:0,l:"—",cc:"1044578"},
{n:"INQUEST",cat:"Care / Advocacy",fc:0,l:"—",cc:"1046650"},
{n:"Geese Theatre Company",cat:"Arts + Youth",fc:0,l:"—",cc:"1035783"},
{n:"Mousetrap Theatre Projects",cat:"Arts + Youth",fc:0,l:"—",cc:"1063120"},
{n:"Catch22",cat:"Care / Advocacy",fc:0,l:"—",cc:"1124127"},
{n:"St Giles Trust",cat:"Care / Advocacy",fc:0,l:"—",cc:"801355"},
{n:"Revolving Doors Agency",cat:"Care / Advocacy",fc:0,l:"—",cc:"1030846"},
];

const ALRT=[];
const SRCS=[
{n:"360Giving API",d:"Live scanning 800k+ UK grants. Finds every funder of your comparable orgs — real data, not guesswork.",st:"live",v:"Discovery engine",c:"Data APIs"},
{n:"Charity Commission",d:"Charitable objects + trustees for every UK charity. Cross-reference trustee networks.",st:"planned",v:"Enrichment",c:"Data APIs"},
{n:"GLA / Mayor's Fund",d:"London statutory funding for youth services and cultural programmes.",st:"live",v:"£20k–£100k",c:"Statutory"},
{n:"Ministry of Justice — Youth Justice",d:"MoJ funds for orgs working with young people in/leaving criminal justice.",st:"idea",v:"£50k–£500k",c:"Statutory"},
{n:"NHS England — CYP Mental Health",d:"Commissioning for children's mental health. CAMHS transition advocacy relevant.",st:"idea",v:"£30k–£200k",c:"Statutory"},
{n:"London Community Foundation",d:"Place-based giving for London boroughs. Multiple funds open year-round.",st:"live",v:"£5k–£50k",c:"Community"},
{n:"Crowdfunding Campaigns",d:"For specific campaigns: DoLs advocacy, Blaze FM tour. Builds engagement.",st:"idea",v:"£5k–£30k",c:"Individual"},
{n:"UKRI Research Partnerships",d:"Universities fund research into your outcomes. You provide access.",st:"idea",v:"£20k–£100k",c:"Academic"},
{n:"Corporate Volunteering Days",d:"Companies pay for employee volunteering with young people.",st:"idea",v:"£500–£2k/day",c:"Corporate"},
{n:"Creative Europe / British Council",d:"International funding for touring or cross-border projects.",st:"idea",v:"€10k–€200k",c:"International"},
];

// ═══════════════════════════════════════════════════════════════
// HELPERS
// ═══════════════════════════════════════════════════════════════
const fm=n=>n!=null?'£'+Math.abs(n).toLocaleString():'—';
const fs=n=>{if(n==null)return'—';return(n<0?'-':'')+fm(n)};
const pc=n=>n!=null?(n*100).toFixed(0)+'%':'—';
const vc=n=>n<0?'var(--rd)':n>0?'var(--gn)':'#fff';
const inP=name=>PIPE.some(p=>p.f.toLowerCase()===name.toLowerCase());
const esc=s=>s.replace(/'/g,"&#39;");

function toast(m,err){const c=document.getElementById('tc');const d=document.createElement('div');d.className='toast'+(err?' err':'');d.textContent=m;c.appendChild(d);setTimeout(()=>d.remove(),3000)}

function addP(name,type,v,yr){
  if(inP(name)){toast('"'+name+'" already in pipeline');return}
  PIPE.push({id:S.nid++,f:name,tm:'—',ph:'Research',fo:'Core',is:type||'T&F',yr:yr||2026,st:'Prospect',w:.05,v:v||0,src:'local'});
  toast('Added "'+name+'" to pipeline');writePipeline();R();
}

function toggleSt(id){
  const p=PIPE.find(x=>x.id===id);if(!p)return;
  const i=STATS.indexOf(p.st);p.st=STATS[(i+1)%STATS.length];
  if(p.st==='Secured')p.w=1;else if(p.st==='Unsuccessful')p.w=0;
  writePipeline();R();
}

function parseNum(v){if(!v)return 0;let s=String(v).replace(/[£,%\s]/g,'');if(s.startsWith('(')&&s.endsWith(')'))s='-'+s.slice(1,-1);s=s.replace(/,/g,'');const n=parseFloat(s);return isNaN(n)?0:n}
function gC(d,r,c){return d&&d[r]&&d[r][c]!==undefined?parseNum(d[r][c]):0}
function gS(d,r,c){return d&&d[r]&&d[r][c]!==undefined?String(d[r][c]).trim():''}

// ═══════════════════════════════════════════════════════════════
// GOOGLE SHEETS — READ FINANCIAL DATA
// ═══════════════════════════════════════════════════════════════
async function fetchSD(){
  try{
    const rng=['Claude data!A1:C30','Fundraising Targets!A1:H30','3-year income overview!A60:L80'];
    const urls=rng.map(r=>`https://sheets.googleapis.com/v4/spreadsheets/${SID}/values/${encodeURIComponent(r)}?key=${AK}`);
    const res=await Promise.all(urls.map(u=>fetch(u)));
    if(!res.every(r=>r.ok))throw new Error('Sheet API error');
    const[cd,ft,ro]=await Promise.all(res.map(x=>x.json()));
    return parseSD(cd.values||[],ft.values||[],ro.values||[]);
  }catch(e){console.error('Sheet fetch:',e);return null}
}

function parseSD(cl,tg,ro){
  const NM=['Corporate','Individual','T&F','Statutory','Earned','Tax Relief','Events','Interest'];
  const p={
    2026:{tgt:gC(cl,1,0),exp:gC(cl,26,0),sur:gC(cl,22,0),sec:gC(cl,7,0),pct:gC(cl,19,0),gap:gC(cl,16,0),wp:gC(cl,13,0),tp:gC(cl,10,0),iT:Array.from({length:8},(_,i)=>gC(tg,8+i,5)),iA:Array.from({length:8},(_,i)=>gC(tg,20+i,5))},
    2027:{tgt:gC(cl,1,1),exp:gC(cl,26,1),sur:gC(cl,22,1),sec:gC(cl,7,1),pct:gC(cl,19,1),gap:gC(cl,16,1),wp:gC(cl,13,1),iT:Array.from({length:8},(_,i)=>gC(tg,8+i,7)),iA:Array.from({length:8},(_,i)=>gC(tg,20+i,7))},
    2028:{tgt:gC(cl,1,2),exp:gC(cl,26,2),sur:gC(cl,22,2),sec:gC(cl,7,2)},
    nm:NM,roles:[]
  };
  for(let i=0;i<10;i++){const nm=gS(ro,4+i,1);if(nm)p.roles.push({n:nm,g26:gC(ro,4+i,9),g27:gC(ro,4+i,11)})}
  p.oh26=gC(ro,17,9);p.oh27=gC(ro,17,11);
  return p;
}

// ═══════════════════════════════════════════════════════════════
// GOOGLE SHEETS — READ/WRITE PIPELINE
// Pipeline tab columns: A=Funder, B=Owner, C=Phase, D=Focus,
// E=Type, F=Year, G=Status, H=Ask, I=Probability, J=Weighted
// ═══════════════════════════════════════════════════════════════
async function readPipeline(){
  try{
    const url=`https://sheets.googleapis.com/v4/spreadsheets/${SID}/values/${encodeURIComponent('Pipeline!A2:J200')}?key=${AK}`;
    const res=await fetch(url);
    if(!res.ok){console.log('No Pipeline tab yet — using empty pipeline');return[]}
    const data=await res.json();
    const rows=data.values||[];
    return rows.filter(r=>r[0]).map((r,i)=>({
      id:i+1,f:r[0]||'',tm:r[1]||'—',ph:r[2]||'Research',fo:r[3]||'Core',
      is:r[4]||'T&F',yr:parseInt(r[5])||2026,st:r[6]||'Prospect',
      v:parseNum(r[7]),w:parseNum(r[8])||.05,src:'sheet'
    }));
  }catch(e){console.error('Pipeline read:',e);return[]}
}

async function writePipeline(){
  // Write pipeline back to sheet via Apps Script proxy
  // For now, flag that local changes exist
  S.pipelineDirty=true;
}

// ═══════════════════════════════════════════════════════════════
// 360GIVING — LIVE FUNDER DISCOVERY
// ═══════════════════════════════════════════════════════════════
async function fetch360(orgCC){
  const orgId=`GB-CHC-${orgCC}`;
  const url=`${API360}/org/${orgId}/grants_received/?limit=100`;
  try{
    const res=await fetch(url,{headers:{'Accept':'application/json'}});
    if(!res.ok)return[];
    const data=await res.json();
    return data.results||[];
  }catch(e){console.error('360G fetch:',orgCC,e);return[]}
}

async function scanComparables(){
  if(S.scanning)return;
  S.scanning=true;S.scanTotal=COMPS.length;S.scanProg=0;
  FUNDER_DB={};
  toast('Scanning '+COMPS.length+' orgs via 360Giving...');R();

  for(let ci=0;ci<COMPS.length;ci++){
    const comp=COMPS[ci];
    S.scanProg=ci;R();
    const grants=await fetch360(comp.cc);
    comp.fc=grants.length;
    comp.l=new Date().toLocaleDateString('en-GB',{month:'short',year:'numeric'});

    grants.forEach(g=>{
      const gd=g.data||g;
      const funderOrgs=gd.fundingOrganization||[];
      funderOrgs.forEach(fo=>{
        const fn=fo.name;if(!fn)return;
        if(!FUNDER_DB[fn])FUNDER_DB[fn]={orgs:new Set(),grants:[],totalValue:0,lastYear:0};
        FUNDER_DB[fn].orgs.add(comp.n);
        const amt=gd.amountAwarded||0;
        const yr=gd.awardDate?parseInt(gd.awardDate.substring(0,4)):0;
        FUNDER_DB[fn].grants.push({recipient:comp.n,amount:amt,year:yr,title:gd.title||''});
        FUNDER_DB[fn].totalValue+=amt;
        if(yr>FUNDER_DB[fn].lastYear)FUNDER_DB[fn].lastYear=yr;
      });
    });
    // Rate limit: 2 req/sec max
    await new Promise(r=>setTimeout(r,600));
  }

  // Build discovery feed from FUNDER_DB
  buildDiscovery();
  S.scanning=false;S.discLoaded=true;S.scanProg=COMPS.length;
  toast('Scan complete: '+Object.keys(FUNDER_DB).length+' funders found across '+COMPS.length+' orgs');
  R();
}

function buildDiscovery(){
  // Score and rank funders
  const entries=Object.entries(FUNDER_DB);
  DISC=[];OVER=[];

  entries.forEach(([name,data])=>{
    const orgCount=data.orgs.size;
    const grantCount=data.grants.length;
    const avgGrant=grantCount>0?Math.round(data.totalValue/grantCount):0;
    const maxGrant=Math.max(...data.grants.map(g=>g.amount),0);
    const recency=data.lastYear>=2023?1:data.lastYear>=2020?.7:.4;

    // Alignment score: overlap × recency × size relevance
    // TBH sweet spot is £5k-£150k grants
    const sizeMatch=avgGrant>=5000&&avgGrant<=150000?1:avgGrant<5000?.5:.6;
    const score=Math.min(Math.round((orgCount/COMPS.length*40 + recency*30 + sizeMatch*30)),99);

    // Build range string
    const minG=Math.min(...data.grants.map(g=>g.amount));
    const maxG=maxGrant;
    const range=grantCount>0?'£'+Math.round(minG/1000)+'k–£'+Math.round(maxG/1000)+'k':'—';

    DISC.push({
      n:name,s:score,t:'T&F',
      a:Array.from(data.orgs).join(', '),
      r:range,rl:['Core','Programme','Advocacy'],
      desc:grantCount+' grants found, avg '+fm(avgGrant)+', most recent '+data.lastYear,
      orgs:Array.from(data.orgs),orgCount,grantCount,avgGrant,maxGrant,lastYear:data.lastYear
    });

    // Build overlap data for orgs with 2+ overlaps
    if(orgCount>=2){
      OVER.push({n:name,c:orgCount,o:Array.from(data.orgs),s:score,
        totalGrants:grantCount,totalValue:data.totalValue});
    }
  });

  // Sort discovery by score desc
  DISC.sort((a,b)=>b.s-a.s);
  OVER.sort((a,b)=>b.c-a.c||b.s-a.s);

  // Generate alerts from top findings
  ALRT.length=0;
  const top3=DISC.filter(d=>!inP(d.n)).slice(0,3);
  top3.forEach(d=>{ALRT.push({t:d.n+' scores '+d.s+'% — funds '+d.orgCount+' comparables',p:d.s>70?'urgent':'high',w:'Just now'})});
  const bigOverlap=OVER.filter(o=>o.c>=4).slice(0,2);
  bigOverlap.forEach(o=>{ALRT.push({t:o.n+' funds '+o.c+' of your comparables ('+fm(o.totalValue)+' total)',p:'urgent',w:'Just now'})});
}

// ═══════════════════════════════════════════════════════════════
// RENDER
// ═══════════════════════════════════════════════════════════════
let CI=null;
function R(){
  const a=document.getElementById('app');const d=S.sd;const y=d?d[S.yr]:null;
  const gk=S.yr==='2027'?'g27':'g26';
  const showRoles=S.yr!=='2028';
  let h='';

  // Header
  h+=`<div class="hdr"><div><div class="hdr-t"><span>TBH</span> FUNDING INTELLIGENCE</div><div class="hdr-s">The Big House · Live Data from Google Sheets + 360Giving API</div></div><div class="hdr-r"><button class="scan" onclick="scanComparables()" ${S.scanning?'disabled style="opacity:.5"':''}>${S.scanning?'SCANNING...':'SCAN 360GIVING'}</button><div style="font-size:10px;color:var(--mt)">${S.discLoaded?Object.keys(FUNDER_DB).length+' funders loaded':'Click to scan'}</div></div></div>`;

  // Scan progress bar
  if(S.scanning)h+=`<div class="prog"><div class="prog-bar" style="width:${(S.scanProg/S.scanTotal)*100}%"></div></div><div style="font-size:10px;color:var(--mt);margin-bottom:12px">Scanning ${COMPS[S.scanProg]?.n||'...'} (${S.scanProg+1}/${S.scanTotal})</div>`;

  // Nav
  const discCount=DISC.filter(x=>!inP(x.n)).length;
  const tabs=[{k:'overview',l:'OVERVIEW'},{k:'pipeline',l:'PIPELINE'},{k:'discovery',l:'DISCOVERY',b:discCount||null},{k:'roles',l:'ROLE MATCH'},{k:'overlap',l:'FUNDER OVERLAP',b:OVER.length||null},{k:'sources',l:'FUNDING SOURCES'},{k:'comparables',l:'MONITORED ORGS'},{k:'alerts',l:'ALERTS',b:ALRT.length||null}];
  h+='<div class="nav">';tabs.forEach(t=>{h+=`<button class="nav-b ${S.tab===t.k?'on':''}" onclick="S.tab='${t.k}';R()">${t.l}${t.b?`<span class="badge">${t.b}</span>`:''}</button>`});h+='</div>';

  // Year tabs
  if(['overview','roles'].includes(S.tab)){h+='<div class="yr-tabs">';['2026','2027','2028'].forEach(v=>{h+=`<button class="yr-b ${S.yr===v?'on':''}" onclick="S.yr='${v}';R()">${v}</button>`});h+='</div>'}

  // ── OVERVIEW ──
  if(S.tab==='overview'){
    if(!d)h+='<div class="ld"><div class="sp"></div>Connecting to Google Sheets...</div>';
    else{
      h+=`<div class="sec-t">FINANCIAL OVERVIEW</div><div class="mrow">`;
      h+=mc('INCOME TARGET',y?.tgt,'#fff')+mc('FORECAST EXPENDITURE',Math.abs(y?.exp||0),'#fff')+mc('PLANNED SURPLUS / DEFICIT',y?.sur,vc(y?.sur||0));
      h+='</div><div class="sec-t">SECURED INCOME AGAINST TARGET</div><div class="mrow">';
      h+=mc('SECURED INCOME',y?.sec,'#fff');
      const pv=y?.pct;h+=`<div class="mc"><div class="mc-l">TARGET REACHED</div><div class="mc-v">${pv?(typeof pv==='number'&&pv<1?(pv*100).toFixed(0)+'%':Math.round(pv)+'%'):'—'}</div></div>`;
      h+=mc('FUNDING GAP',y?.gap,vc(y?.gap||0));
      h+='</div>';
      if(S.yr!=='2028'){
        h+='<div class="sec-t">PIPELINE ANALYSIS</div><div class="mrow">';
        h+=mc('WEIGHTED PIPELINE',y?.wp,'#fff');
        const cg=y?.wp!=null&&y?.gap!=null?(y.wp+y.gap>=0):null;
        h+=`<div class="mc"><div class="mc-l">PIPELINE COVERS GAP</div><div class="mc-v" style="color:${cg?'var(--gn)':'var(--rd)'}">${cg===null?'—':cg?'YES':'NO'}</div></div>`;
        h+=mc('ACTIVE APPLICATIONS',PIPE.filter(p=>p.st==='Applied for').length,'#fff');
        h+='</div>';
      }
      // Gap bars
      h+='<div style="background:var(--cd);border:1px solid var(--bd);border-radius:4px;padding:14px;margin:14px 0"><div class="sec-t" style="margin-bottom:10px">FUNDING GAP TRACKER</div>';
      if(d[2026])h+=gapB('2026',d[2026].sec,d[2026].tgt,d[2026].wp);
      if(d[2027])h+=gapB('2027',d[2027].sec,d[2027].tgt,d[2027].wp);
      h+='</div>';
      // Chart
      if(y?.iT)h+=`<div class="cc"><div class="sec-t">INCOME STREAMS: TARGET VS ACTUAL (${S.yr})</div><div style="position:relative;height:300px"><canvas id="ic"></canvas></div></div>`;
      // Role gap table
      if(d.roles&&d.roles.length>0&&showRoles){
        h+='<div class="cc"><div class="sec-t">INCOME GAP BY ROLE ('+S.yr+')</div><div class="tw"><table style="min-width:400px"><thead><tr><th>ROLE</th><th style="text-align:right">GAP</th></tr></thead><tbody>';
        d.roles.forEach(r=>{const g=r[gk];h+=`<tr><td style="font-weight:600">${r.n}</td><td class="bb" style="font-size:14px;text-align:right;color:${vc(g)}">${fs(g)}</td></tr>`});
        const oh=S.yr==='2026'?d.oh26:d.oh27;
        h+=`<tr style="border-top:2px solid var(--bd)"><td style="font-weight:700">Overheads</td><td class="bb" style="font-size:14px;text-align:right;color:${vc(oh)}">${fs(oh)}</td></tr>`;
        h+='</tbody></table></div></div>';
      }
    }
  }

  // ── PIPELINE ──
  if(S.tab==='pipeline'){
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px"><div class="flt" style="margin-bottom:0">';
    ['all','Secured','Applied for','Prospect','EOI','Unsuccessful'].forEach(s=>{h+=`<button class="fb ${S.sF===s?'on':''}" onclick="S.sF='${s}';R()">${s==='all'?'All':s}</button>`});
    h+='<div class="fsep"></div>';['all','2026','2027'].forEach(v=>{h+=`<button class="fb ${S.yF===v?'on':''}" onclick="S.yF='${v}';R()">${v==='all'?'All years':v}</button>`});
    h+='<div class="fsep"></div>';['all','Kashvi','Zoe','James','Molly'].forEach(t=>{h+=`<button class="fb ${S.tF===t?'on':''}" onclick="S.tF='${t}';R()">${t==='all'?'All':t}</button>`});
    h+=`</div><div style="display:flex;gap:6px"><button class="scan" style="font-size:11px;padding:6px 14px;white-space:nowrap" onclick="S.modal='prospect';R()">+ ADD PROSPECT</button><button class="dbtn" style="font-size:10px" onclick="exportCSV()">EXPORT CSV</button></div></div>`;
    if(S.pipelineDirty)h+='<div style="font-size:10px;color:var(--yl);margin-bottom:8px">⚠ Local changes not yet synced to sheet</div>';
    if(S.pipeSource==='fallback')h+='<div style="font-size:10px;color:var(--sc);margin-bottom:8px">Pipeline loaded from last known data. To make this live, add a "Pipeline" tab to your Google Sheet.</div>';
    if(PIPE.length===0)h+='<div style="text-align:center;padding:40px;color:var(--mt)">No pipeline data. Add a "Pipeline" tab to your Google Sheet, or click + ADD PROSPECT.</div>';
    else{
      let fl=PIPE.filter(p=>{if(S.sF!=='all'&&p.st!==S.sF)return false;if(S.yF!=='all'&&p.yr!==parseInt(S.yF))return false;if(S.tF!=='all'&&p.tm!==S.tF)return false;return true}).sort((a,b)=>(b.v*b.w)-(a.v*a.w));
      h+='<div class="tw"><table><thead><tr>';['FUNDER','OWNER','PHASE','FOCUS','TYPE','YEAR','STATUS','ASK','PROB','WEIGHTED'].forEach(x=>{h+=`<th>${x}</th>`});h+='</tr></thead><tbody>';
      fl.forEach(p=>{
        const wv=Math.round(p.v*p.w),fc=p.fo==='Blaze FM'?'var(--tl)':p.fo==='DoLs'?'var(--bl)':p.fo==='Gypsy / Coward'?'var(--pk)':'var(--sc)',pcl=p.w>=.5?'var(--gn)':p.w>=.1?'var(--yl)':'var(--rd)',sc=SBC[p.st]||'';
        h+=`<tr><td style="font-weight:600;color:#fff">${p.f}</td><td style="color:var(--sc)">${p.tm}</td><td style="color:var(--sc)">${p.ph}</td><td style="color:${fc}">${p.fo}</td><td style="color:var(--sc)">${p.is}</td><td style="color:var(--sc)">${p.yr||'—'}</td><td><span class="sb ${sc}" onclick="toggleSt(${p.id})"><span class="dt"></span>${p.st}</span></td><td class="bb" style="font-size:14px">${fm(p.v)}</td><td class="bb" style="font-size:14px;color:${pcl}">${pc(p.w)}</td><td class="bb" style="font-size:14px;color:var(--tl);font-weight:700">${fm(wv)}</td></tr>`;
      });
      h+=`</tbody></table><div class="tf"><span style="color:var(--mt)">${fl.length} entries</span><span style="color:var(--tl);font-weight:700">Weighted total: ${fm(fl.reduce((a,p)=>a+Math.round(p.v*p.w),0))}</span></div></div>`;
    }
  }

  // ── DISCOVERY ──
  if(S.tab==='discovery'){
    if(!S.discLoaded){
      h+='<div style="text-align:center;padding:60px 20px"><div style="font-size:14px;font-weight:700;margin-bottom:8px">No scan data yet</div><div style="font-size:12px;color:var(--sc);margin-bottom:16px;max-width:500px;margin-left:auto;margin-right:auto">Click SCAN 360GIVING to discover funders from real grant data across '+COMPS.length+' comparable organisations.<br><br><span style="color:var(--yl)">Note:</span> The 360Giving API requires this page to be deployed (e.g. GitHub Pages). It won\'t work in preview modes.</div><button class="scan" onclick="scanComparables()">SCAN NOW</button></div>';
    }else{
      const notInPipe=DISC.filter(d=>!inP(d.n));
      h+=`<div style="font-size:12px;color:var(--sc);margin-bottom:12px">${DISC.length} funders found from ${COMPS.length} comparable orgs via 360Giving. Showing ${notInPipe.length} not yet in pipeline. <span class="src-tag">LIVE DATA</span></div>`;
      h+='<div class="dg">';
      notInPipe.slice(0,50).forEach(d=>{
        const cl=d.s>=70?'hi':d.s>=50?'md':'lo',co=d.s>=70?'var(--gn)':d.s>=50?'var(--yl)':'var(--rd)';
        h+=`<div class="dc ${cl}"><div style="display:flex;justify-content:space-between"><div><div style="font-size:13px;font-weight:700">${d.n}</div><div style="font-size:10px;color:var(--mt);margin-top:2px">${d.orgCount} comparable${d.orgCount>1?'s':''} · ${d.grantCount} grants · avg ${fm(d.avgGrant)}</div></div><span class="bb" style="font-size:22px;color:${co}">${d.s}%</span></div><div style="font-size:10px;color:var(--sc);margin-top:4px">${d.desc}</div><div style="font-size:10px;color:var(--mt);margin-top:4px">Funds: ${d.a}</div><div style="display:flex;gap:6px;margin-top:8px"><button class="abtn" onclick="addP('${esc(d.n)}','T&F',${d.avgGrant||0},2026)">ADD TO PIPELINE</button><button class="dbtn">Details</button></div></div>`;
      });
      h+='</div>';
      if(notInPipe.length>50)h+=`<div style="text-align:center;padding:12px;color:var(--mt);font-size:11px">${notInPipe.length-50} more funders available — refine with filters</div>`;
    }
  }

  // ── ROLE MATCH ──
  if(S.tab==='roles'){
    if(!showRoles){h+='<div style="text-align:center;padding:40px;color:var(--mt);font-size:14px">Role gap data not yet available for 2028.</div>';}
    else{
      h+='<div style="font-size:12px;color:var(--sc);margin-bottom:12px">Roles with a funding gap. Click a funder tag to add to pipeline.</div>';
      if(d&&d.roles){
        const uf=d.roles.filter(r=>r[gk]<0);
        uf.forEach(role=>{
          const topFunders=DISC.slice(0,8);
          h+=`<div class="rc"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div style="font-size:14px;font-weight:700">${role.n}</div><span class="bb" style="font-size:20px;color:var(--rd)">${fs(role[gk])}</span></div><div style="font-size:10px;color:var(--pk);font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Suggested funders${S.discLoaded?' (from 360Giving)':''}:</div><div>${topFunders.length>0?topFunders.map(f=>{const ip=inP(f.n);return`<span class="rft ${ip?'done':''}" ${ip?'':`onclick="addP('${esc(f.n)}','T&F',${f.avgGrant||0},${parseInt(S.yr)})"`}>${ip?'✓ ':''}${f.n} (${f.s}%)${ip?'':' +'}</span>`}).join(''):'<span style="color:var(--mt)">Run scan to find funders</span>'}</div></div>`;
        });
        const ff=d.roles.filter(r=>r[gk]>=0);
        if(ff.length>0){h+='<div class="sec-t" style="margin-top:16px">FUNDED ROLES</div>';ff.forEach(r=>{h+=`<div class="rc" style="border-left:3px solid var(--gn)"><div style="display:flex;justify-content:space-between;align-items:center"><div style="font-size:14px;font-weight:700">${r.n}</div><span class="bb" style="font-size:20px;color:var(--gn)">${fs(r[gk])}</span></div></div>`})}
      }else h+='<div class="ld"><div class="sp"></div>Loading roles...</div>';
    }
  }

  // ── FUNDER OVERLAP ──
  if(S.tab==='overlap'){
    if(!S.discLoaded)h+='<div style="text-align:center;padding:60px 20px"><div style="font-size:14px;font-weight:700;margin-bottom:8px">Run a scan first</div><div style="font-size:12px;color:var(--sc);margin-bottom:16px">Overlap data is computed from real 360Giving grant records. Deploy to GitHub Pages and click SCAN.</div><button class="scan" onclick="scanComparables()">SCAN NOW</button></div>';
    else{
      h+=`<div style="font-size:12px;color:var(--sc);margin-bottom:12px">${OVER.length} funders support 2+ of your comparable orgs. <span class="src-tag">LIVE DATA</span></div>`;
      OVER.slice(0,30).forEach(o=>{const ip=inP(o.n);
        h+=`<div class="oc"><div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-size:13px;font-weight:700">${o.n}</div><div style="font-size:10px;color:var(--mt)">Alignment: ${o.s}% · ${o.totalGrants} grants · ${fm(o.totalValue)} total</div></div><div style="display:flex;align-items:center;gap:10px"><span class="bb" style="font-size:18px;color:var(--pk)">${o.c} ORGS</span>${ip?'<span style="font-size:10px;color:var(--gn);font-weight:700">✓ Pipeline</span>':`<button class="abtn" onclick="addP('${esc(o.n)}','T&F',${Math.round(o.totalValue/o.totalGrants)||0},2026)">ADD</button>`}</div></div><div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:6px">${o.o.map(x=>`<span class="ot">${x}</span>`).join('')}</div></div>`;
      });
    }
  }

  // ── FUNDING SOURCES ──
  if(S.tab==='sources'){
    h+='<div style="font-size:12px;color:var(--sc);margin-bottom:12px">Beyond trusts & corporates — additional streams to diversify income.</div>';
    [...new Set(SRCS.map(x=>x.c))].forEach(cat=>{
      h+=`<div class="sec-t" style="margin-top:16px">${cat.toUpperCase()}</div>`;
      SRCS.filter(x=>x.c===cat).forEach(s=>{
        const sc=s.st==='live'?'sc-live':s.st==='planned'?'sc-plan':'sc-idea';
        h+=`<div class="sc-c"><div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px"><div style="font-size:14px;font-weight:700">${s.n}</div><span class="sc-st ${sc}">${s.st.toUpperCase()}</span></div><div style="font-size:11px;color:var(--sc);margin-bottom:8px">${s.d}</div><div style="font-size:12px;color:var(--tl);font-weight:700">${s.v}</div></div>`;
      });
    });
  }

  // ── COMPARABLES ──
  if(S.tab==='comparables'){
    h+=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px"><div style="font-size:12px;color:var(--sc)">Organisations monitored via 360Giving API. ${S.discLoaded?'<span class="src-tag">LIVE DATA</span>':''}</div><button class="scan" style="font-size:11px;padding:6px 14px" onclick="S.modal='org';R()">+ ADD ORG</button></div>`;
    h+='<div class="tw"><table style="min-width:600px"><thead><tr><th>ORGANISATION</th><th>CATEGORY</th><th>CHARITY NO.</th><th>GRANTS FOUND</th><th>LAST SCANNED</th></tr></thead><tbody>';
    COMPS.forEach(c=>{h+=`<tr><td style="font-weight:600">${c.n}</td><td style="color:var(--sc)">${c.cat}</td><td style="color:var(--sc)">${c.cc}</td><td style="color:var(--tl);font-weight:700">${c.fc}</td><td style="color:var(--sc)">${c.l}</td></tr>`});
    h+='</tbody></table></div>';
  }

  // ── ALERTS ──
  if(S.tab==='alerts'){
    if(ALRT.length===0)h+='<div style="text-align:center;padding:40px;color:var(--mt)">No alerts yet. Run a scan to generate alerts from discovery data.</div>';
    else{
      h+='<div style="background:var(--cd);border:1px solid var(--bd);border-radius:4px;padding:16px">';
      ALRT.forEach(a=>{const dc=a.p==='urgent'?'var(--rd)':a.p==='high'?'var(--yl)':'var(--bl)';h+=`<div style="display:flex;align-items:flex-start;gap:10px;padding:8px 0;border-bottom:1px solid var(--bd)"><div style="width:7px;height:7px;border-radius:50%;margin-top:5px;flex-shrink:0;background:${dc}"></div><div style="flex:1"><div style="font-size:12px;font-weight:500">${a.t}</div><div style="font-size:9px;color:var(--mt)">${a.w}</div></div></div>`});
      h+='</div>';
    }
  }

  // ── MODALS ──
  if(S.modal==='prospect')h+=`<div class="mo" onclick="if(event.target===this){S.modal=null;R()}"><div class="mb"><h3>ADD NEW PROSPECT</h3><label>Funder name</label><input placeholder="e.g. The Rayne Foundation" id="np-f"><label>Ask amount (£)</label><input type="number" placeholder="e.g. 25000" id="np-v"><label>Income type</label><select id="np-t"><option value="T&F">Trusts & Foundations</option><option value="Corporate">Corporate</option><option value="Statutory">Statutory</option><option value="Individual">Individual</option></select><label>Year</label><select id="np-y"><option value="2026">2026</option><option value="2027">2027</option><option value="2028">2028</option></select><label>Focus area</label><select id="np-fo"><option value="Core">Core</option><option value="Blaze FM">Blaze FM</option><option value="DoLs">DoLs</option><option value="Productions">Productions</option></select><label>Team member</label><select id="np-tm"><option value="Kashvi">Kashvi</option><option value="Zoe">Zoe</option><option value="James">James</option><option value="Molly">Molly</option><option value="—">Unassigned</option></select><div class="ma"><button class="mcnl" onclick="S.modal=null;R()">Cancel</button><button class="msub" onclick="addProspect()">Add to Pipeline</button></div></div></div>`;

  if(S.modal==='org')h+=`<div class="mo" onclick="if(event.target===this){S.modal=null;R()}"><div class="mb"><h3>ADD ORGANISATION TO MONITOR</h3><label>Organisation name</label><input placeholder="e.g. Synergy Theatre Project" id="o-n"><label>Charity Commission number</label><input placeholder="Required for 360Giving lookup" id="o-cc"><label>Category</label><select id="o-cat"><option value="Arts + Youth">Arts + Youth</option><option value="Care / Advocacy">Care / Advocacy</option><option value="Adjacent">Adjacent</option></select><div class="ma"><button class="mcnl" onclick="S.modal=null;R()">Cancel</button><button class="msub" onclick="addOrg()">Add & Scan</button></div></div></div>`;

  a.innerHTML=h;
  if(S.tab==='overview'&&d)requestAnimationFrame(()=>setTimeout(mkChart,100));
}

// ── Metric card helper ──
function mc(l,v,c){return`<div class="mc"><div class="mc-l">${l}</div><div class="mc-v" style="color:${c}">${fs(v)}</div></div>`}

// ── Gap bar helper ──
function gapB(yr,sec,tgt,wp){
  if(!tgt)return'';sec=sec||0;wp=wp||0;const gap=tgt-sec,cov=wp>=gap,pS=Math.min(sec/tgt*100,100),pW=Math.min((sec+wp)/tgt*100,100);
  return`<div class="gap-c"><div class="gap-h"><span style="font-size:12px;font-weight:700">${yr}</span><span style="font-size:10px;color:${cov?'var(--gn)':'var(--rd)'}">Gap: ${fm(gap)} ${cov?'✓ Covered':'✗ Not covered'}</span></div><div class="gap-trk"><div class="gap-w" style="width:${pW}%"></div><div class="gap-s" style="width:${pS}%"></div></div><div class="gap-f"><span>£0</span><span>Target: ${fm(tgt)}</span></div></div>`;
}

// ── Chart — VERTICAL bars ──
function mkChart(){
  const cv=document.getElementById('ic');if(!cv||!S.sd)return;
  const y=S.sd[S.yr];if(!y||!y.iT)return;
  if(CI)CI.destroy();
  CI=new Chart(cv,{type:'bar',data:{labels:S.sd.nm,datasets:[
    {label:'Target',data:y.iT,backgroundColor:'#68E2D4',borderRadius:3},
    {label:'Actual',data:y.iA,backgroundColor:'#E6007E',borderRadius:3}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{
    legend:{position:'top',labels:{color:'#fff',font:{family:'Lato',size:11},padding:16}},
    tooltip:{callbacks:{label:function(ctx){return ctx.dataset.label+': £'+ctx.parsed.y.toLocaleString()}}}
  },scales:{
    y:{ticks:{color:'#666',callback:v=>'£'+v.toLocaleString()},grid:{color:'#1a1a1a'}},
    x:{ticks:{color:'#fff',font:{family:'Bebas Neue',size:11},maxRotation:45,minRotation:45},grid:{display:false}}
  }}});
}

// ── Modal actions ──
function addProspect(){
  const f=document.getElementById('np-f')?.value;if(!f){toast('Enter a name');return}
  PIPE.push({id:S.nid++,f,tm:document.getElementById('np-tm')?.value||'—',ph:'Research',fo:document.getElementById('np-fo')?.value||'Core',is:document.getElementById('np-t')?.value||'T&F',yr:parseInt(document.getElementById('np-y')?.value)||2026,st:'Prospect',w:.05,v:parseInt(document.getElementById('np-v')?.value)||0,src:'local'});
  toast('Added "'+f+'" to pipeline');S.modal=null;writePipeline();R();
}
function addOrg(){
  const n=document.getElementById('o-n')?.value;if(!n){toast('Enter a name');return}
  const cc=document.getElementById('o-cc')?.value;
  if(!cc){toast('Charity number required for 360Giving lookup',true);return}
  COMPS.push({n,cat:document.getElementById('o-cat')?.value||'Adjacent',fc:0,l:'Pending...',cc});
  toast('Added "'+n+'" — run scan to fetch grants');S.modal=null;R();
}

// ── CSV Export ──
function exportCSV(){
  const hdr=['Funder','Owner','Phase','Focus','Type','Year','Status','Ask','Probability','Weighted'];
  const rows=PIPE.map(p=>[p.f,p.tm,p.ph,p.fo,p.is,p.yr,p.st,p.v,(p.w*100).toFixed(0)+'%',Math.round(p.v*p.w)]);
  const csv=[hdr.join(','),...rows.map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(','))].join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='tbh-pipeline-'+new Date().toISOString().split('T')[0]+'.csv';a.click();
  toast('Pipeline exported as CSV');
}

// ═══════════════════════════════════════════════════════════════
// FALLBACK PIPELINE — used when no Pipeline sheet tab exists
// ═══════════════════════════════════════════════════════════════
const PIPE_FALLBACK=[
{id:1,f:"Loved and Wanted Fund",tm:"Zoe",ph:"Application",fo:"Core",is:"Statutory",yr:2026,st:"Secured",w:1,v:60000},
{id:2,f:"The Lewis Family Foundation",tm:"Zoe",ph:"Application",fo:"Core",is:"Individual",yr:2026,st:"Secured",w:1,v:40000},
{id:3,f:"Sage Publishing",tm:"Molly",ph:"Re-application",fo:"Core",is:"Corporate",yr:2026,st:"Secured",w:1,v:20000},
{id:4,f:"The Spencer Strauss Fund",tm:"Kashvi",ph:"Application",fo:"Core",is:"T&F",yr:2026,st:"Secured",w:1,v:20000},
{id:5,f:"Paul Hamlyn Foundation",tm:"Kashvi",ph:"Application",fo:"Core",is:"T&F",yr:2026,st:"Applied for",w:.2,v:150000},
{id:6,f:"National Lottery Reaching Communities",tm:"Zoe",ph:"Applied for",fo:"Core",is:"T&F",yr:2027,st:"Applied for",w:.03,v:500000},
{id:7,f:"Educational Opportunities Fund",tm:"Zoe",ph:"Stage One",fo:"Core",is:"T&F",yr:2026,st:"Applied for",w:.1,v:90000},
{id:8,f:"ACE NLPG (Blaze FM tour)",tm:"Kashvi",ph:"Application",fo:"Blaze FM",is:"T&F",yr:2026,st:"Applied for",w:.2,v:62000},
{id:9,f:"Compass Wellbeing",tm:"Zoe",ph:"Application",fo:"Core",is:"Statutory",yr:2026,st:"Applied for",w:.1,v:50000},
{id:10,f:"Tweed Family Charitable Trust",tm:"Kashvi",ph:"Stage One",fo:"Core",is:"T&F",yr:2026,st:"Applied for",w:.1,v:30000},
{id:11,f:"Weavers Company",tm:"Kashvi",ph:"Application",fo:"Core",is:"T&F",yr:2026,st:"Applied for",w:.1,v:25000},
{id:12,f:"Christina Smith Foundation",tm:"Kashvi",ph:"Application",fo:"Core",is:"T&F",yr:2026,st:"Applied for",w:.1,v:25000},
{id:13,f:"Cherry Family Foundation",tm:"Kashvi",ph:"EOI",fo:"Core",is:"T&F",yr:2026,st:"Applied for",w:.1,v:20000},
{id:14,f:"Kristina Martin Charitable Trust",tm:"Kashvi",ph:"Application",fo:"Core",is:"T&F",yr:2026,st:"Applied for",w:.1,v:20000},
{id:15,f:"The Laing Family Trust",tm:"Zoe",ph:"Application",fo:"Core",is:"T&F",yr:2026,st:"Applied for",w:.1,v:20000},
{id:16,f:"TELUS",tm:"Kashvi",ph:"Application",fo:"Core",is:"Corporate",yr:2026,st:"Applied for",w:.1,v:20000},
{id:17,f:"Grant Thornton",tm:"Kashvi",ph:"EOI",fo:"Core",is:"Corporate",yr:2026,st:"Applied for",w:.2,v:20000},
{id:18,f:"Hiscox Foundation",tm:"Zoe",ph:"Report",fo:"Core",is:"Corporate",yr:2026,st:"Applied for",w:.5,v:10000},
{id:19,f:"Cadogan Charity",tm:"Zoe",ph:"Letter",fo:"Productions",is:"T&F",yr:2026,st:"Applied for",w:.1,v:10000},
{id:20,f:"Schroder Charitable Foundation",tm:"Kashvi",ph:"Application",fo:"Core",is:"T&F",yr:2026,st:"Applied for",w:.1,v:5000},
{id:21,f:"WillHoughton Foundation",tm:"Zoe",ph:"Application",fo:"Core",is:"T&F",yr:2026,st:"Applied for",w:.2,v:2000},
{id:22,f:"Esmee Fairbairn Foundation",tm:"Kashvi",ph:"EOI",fo:"Core",is:"T&F",yr:2026,st:"Prospect",w:.05,v:200000},
{id:23,f:"Trust for London",tm:"Kashvi",ph:"EOI",fo:"Core",is:"T&F",yr:2026,st:"Prospect",w:.05,v:200000},
{id:24,f:"Thompson Family Charitable Trust",tm:"Kashvi",ph:"Application",fo:"Core",is:"T&F",yr:2026,st:"Prospect",w:.1,v:120000},
{id:25,f:"John Ellerman Foundation",tm:"Zoe",ph:"Research",fo:"Blaze FM",is:"T&F",yr:2027,st:"Prospect",w:.1,v:100000},
{id:26,f:"Mary Kinross Charitable Trust",tm:"Kashvi",ph:"Application",fo:"Core",is:"T&F",yr:2026,st:"Prospect",w:.05,v:90000},
{id:27,f:"The Bromley Trust",tm:"Zoe",ph:"EOI",fo:"Core",is:"T&F",yr:2026,st:"Prospect",w:.05,v:90000},
{id:28,f:"Matchroom Foundation",tm:"Zoe",ph:"Application",fo:"Gypsy / Coward",is:"Corporate",yr:2027,st:"Prospect",w:.2,v:50000},
{id:29,f:"Sony Social Justice Fund",tm:"Kashvi",ph:"EOI",fo:"Blaze FM",is:"Corporate",yr:2026,st:"Prospect",w:.05,v:50000},
{id:30,f:"Blagrave Trust",tm:"Kashvi",ph:"Application",fo:"DoLs",is:"T&F",yr:2026,st:"Prospect",w:.1,v:50000},
{id:31,f:"Charles Plater Trust",tm:"Kashvi",ph:"Application",fo:"Core",is:"T&F",yr:2026,st:"Prospect",w:.1,v:50000},
{id:32,f:"Kilburn and Strode",tm:"Zoe",ph:"Application",fo:"Core",is:"Corporate",yr:2026,st:"Prospect",w:.1,v:30000},
{id:33,f:"Souter Charitable Trust",tm:"Kashvi",ph:"Application",fo:"Core",is:"T&F",yr:2026,st:"Prospect",w:.1,v:30000},
{id:34,f:"Wolfson Foundation",tm:"Kashvi",ph:"Application",fo:"Core",is:"T&F",yr:2026,st:"Prospect",w:.1,v:20000},
{id:35,f:"Mount Fund",tm:"Zoe",ph:"Application",fo:"Core",is:"T&F",yr:2026,st:"Prospect",w:.1,v:20000},
{id:36,f:"JP Morgan Foundation",tm:"Kashvi",ph:"EOI",fo:"Core",is:"Corporate",yr:2027,st:"Prospect",w:.05,v:30000},
{id:37,f:"The Considered Ask",tm:"Kashvi",ph:"EOI",fo:"Core",is:"Corporate",yr:2027,st:"Prospect",w:.05,v:50000},
];

// ═══════════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════════
async function init(){
  // Load financial data from sheets
  S.sd=await fetchSD();
  // Load pipeline from sheet (if Pipeline tab exists), else use fallback
  const sheetPipe=await readPipeline();
  if(sheetPipe.length>0){
    PIPE=sheetPipe;
    S.pipeSource='sheet';
  }else{
    PIPE=PIPE_FALLBACK.map(p=>({...p}));
    S.pipeSource='fallback';
  }
  S.nid=Math.max(...PIPE.map(p=>p.id),0)+1;
  R();
}
document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
